-- Reset DB (MySQL)
DROP DATABASE IF EXISTS QLSV_AT;
CREATE DATABASE QLSV_AT
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
USE QLSV_AT;

-- =========================
-- Cài đặt bảng (ENGINE=InnoDB để hỗ trợ FK)
-- =========================

-- Bảng KHOA
CREATE TABLE KHOA (
  MAKHOA CHAR(5) PRIMARY KEY,
  TENKHOA VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng LOP
CREATE TABLE LOP (
  MALOP CHAR(10) PRIMARY KEY,
  TENLOP VARCHAR(100) NOT NULL,
  MAKHOA CHAR(5) NOT NULL,
  CONSTRAINT FK_LOP_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng SINHVIEN
CREATE TABLE SINH_VIEN (
  MaSV   CHAR(10) PRIMARY KEY,
  HoTen  VARCHAR(100),
  NgaySinh DATE,
  GioiTinh VARCHAR(3),
  MaLop  CHAR(10),
  Email  VARCHAR(100),
  CONSTRAINT FK_SV_LOP FOREIGN KEY (MaLop) REFERENCES LOP(MaLop)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng GIANGVIEN
CREATE TABLE GIANG_VIEN (
  MaGV   CHAR(10) PRIMARY KEY,
  HoTen  VARCHAR(100),
  MAKHOA CHAR(5) NOT NULL,
  Email  VARCHAR(100),
  CONSTRAINT FK_GV_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng PING (mã ping cấp cho SV để xem điểm)
CREATE TABLE PING (
  MASV      CHAR(10) PRIMARY KEY,
  PING_KEY  VARCHAR(255) NOT NULL,
  CREATED_AT DATETIME DEFAULT (UTC_TIMESTAMP())
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng HOC_PHAN
CREATE TABLE HOC_PHAN (
  MAHP CHAR(10) PRIMARY KEY,
  TenHP VARCHAR(100) NOT NULL,
  SoTinChi INT,
  HocKy INT,
  NamHoc CHAR(9),
  MaLop CHAR(10),
  GiangVien VARCHAR(100),
  NgayBatDau DATE,
  NgayKetThuc DATE,
  CONSTRAINT chk_tc CHECK (SoTinChi > 0),
  CONSTRAINT chk_hk CHECK (HocKy BETWEEN 1 AND 3),
  CONSTRAINT FK_HP_LOP FOREIGN KEY (MaLop) REFERENCES LOP(MaLop)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng DIEM 
CREATE TABLE DIEM (
  MASV CHAR(10) NOT NULL,
  MAHP CHAR(10) NOT NULL,
  DIEM_MAHOA VARCHAR(400) NOT NULL,
  CREATED_AT DATETIME DEFAULT (UTC_TIMESTAMP()),
  CREATED_BY VARCHAR(100) NULL,
  PRIMARY KEY (MASV, MAHP),
  CONSTRAINT FK_DIEM_SV FOREIGN KEY (MASV) REFERENCES SINH_VIEN(MASV),
  CONSTRAINT FK_HO FOREIGN KEY (MAHP) REFERENCES HOC_PHAN(MAHP)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng TAIKHOAN
CREATE TABLE TAIKHOAN (
  USERNAME VARCHAR(50) PRIMARY KEY,
  PASSWORD_HASH VARCHAR(255) NOT NULL,
  `ROLE` VARCHAR(20) NOT NULL,
  Email VARCHAR(100),
  RELATED_ID VARCHAR(20) NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- =========================
-- DỮ LIỆU MẪU
-- =========================
INSERT INTO KHOA (MAKHOA, TENKHOA) VALUES
('K001','Công nghệ thông tin'),
('K002','Toán - Tin'),
('K003','Kinh tế');

INSERT INTO LOP (MALOP, TENLOP, MAKHOA) VALUES
('L001','CTK42','K001'),
('L002','CTK43','K001'),
('L003','KT01','K002');

INSERT INTO SINH_VIEN (MaSV, HoTen, MaLop) VALUES
('SV001','Nguyễn Văn A','L001'),
('SV002','Trần Thị B','L001'),
('SV003','Lê Văn C','L002'),
('SV004','Phạm Thị D','L003'),
('SV005','Hoàng Văn E','L002');

INSERT INTO GIANG_VIEN (MaGV, HoTen, MAKHOA) VALUES
('GV001','TS. Mai Anh','K001'),
('GV002','ThS. Phan Long','K002');

INSERT INTO TAIKHOAN (USERNAME, PASSWORD_HASH, `ROLE`, RELATED_ID) VALUES
('admin','FAKEHASH_ADMIN','ADMIN',NULL),
('gv_maianh','FAKEHASH_GV1','GIANGVIEN','GV001'),
('sv_nguyena','FAKEHASH_SV1','SINHVIEN','SV001');

INSERT INTO PING (MASV, PING_KEY) VALUES
('SV001','PING-SV001-ABC'),
('SV002','PING-SV002-ABC'),
('SV003','PING-SV003-ABC'),
('SV004','PING-SV004-ABC'),
('SV005','PING-SV005-ABC');

INSERT INTO HOC_PHAN (MAHP, TenHP, SoTinChi, HocKy, NamHoc, MaLop, GiangVien, NgayBatDau, NgayKetThuc) VALUES
('HP004', 'Lập trình Java', 3, 1, '2025-2026', 'L003', 'Nguyễn Văn C', '2025-09-01', '2025-12-20'),
('HP001', 'Lập trình C#',   3, 1, '2025-2026', 'L001', 'Nguyễn Văn A', '2025-09-01', '2025-12-20'),
('HP002', 'Lập trình Java', 3, 1, '2025-2026', 'L002', 'Nguyễn Văn C', '2025-09-01', '2025-12-20');

INSERT INTO DIEM (MASV, MAHP, DIEM_MAHOA, CREATED_BY) VALUES
('SV001','HP001','ENCRYPTED_CRT_SV001_HP001','GV001'),
('SV002','HP002','ENCRYPTED_CRT_SV002_HP001','GV001');

-- =========================
-- STORED PROCEDURES (MySQL)
-- =========================
DELIMITER //

DROP PROCEDURE IF EXISTS sp_ThemSinhVien //
CREATE PROCEDURE sp_ThemSinhVien(
  IN p_MASV CHAR(10),
  IN p_HOTEN VARCHAR(100),
  IN p_MALOP CHAR(10)
)
BEGIN
  IF EXISTS (SELECT 1 FROM SINH_VIEN WHERE MaSV = p_MASV) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mã sinh viên đã tồn tại.';
  ELSE
    INSERT INTO SINH_VIEN (MaSV, HoTen, MaLop) VALUES (p_MASV, p_HOTEN, p_MALOP);
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_SuaSinhVien //
CREATE PROCEDURE sp_SuaSinhVien(
  IN p_MASV CHAR(10),
  IN p_HOTEN VARCHAR(100),
  IN p_MALOP CHAR(10)
)
BEGIN
  IF NOT EXISTS (SELECT 1 FROM SINH_VIEN WHERE MaSV = p_MASV) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không tìm thấy sinh viên.';
  ELSE
    UPDATE SINH_VIEN SET HoTen = p_HOTEN, MaLop = p_MALOP WHERE MaSV = p_MASV;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XoaSinhVien //
CREATE PROCEDURE sp_XoaSinhVien(IN p_MASV CHAR(10))
BEGIN
  DELETE FROM DIEM WHERE MaSV = p_MASV;
  DELETE FROM PING WHERE MaSV = p_MASV;
  DELETE FROM SINH_VIEN WHERE MaSV = p_MASV;
END //

-- LỚP
DROP PROCEDURE IF EXISTS sp_ThemLop //
CREATE PROCEDURE sp_ThemLop(
  IN p_MALOP CHAR(10),
  IN p_TENLOP VARCHAR(100),
  IN p_MAKHOA CHAR(5)
)
BEGIN
  IF EXISTS (SELECT 1 FROM LOP WHERE MALOP = p_MALOP) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mã lớp đã tồn tại.';
  ELSE
    INSERT INTO LOP (MALOP, TENLOP, MAKHOA) VALUES (p_MALOP, p_TENLOP, p_MAKHOA);
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_SuaLop //
CREATE PROCEDURE sp_SuaLop(
  IN p_MALOP CHAR(10),
  IN p_TENLOP VARCHAR(100),
  IN p_MAKHOA CHAR(5)
)
BEGIN
  IF NOT EXISTS (SELECT 1 FROM LOP WHERE MALOP = p_MALOP) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không tìm thấy lớp.';
  ELSE
    UPDATE LOP SET TENLOP = p_TENLOP, MAKHOA = p_MAKHOA WHERE MALOP = p_MALOP;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XoaLop //
CREATE PROCEDURE sp_XoaLop(IN p_MALOP CHAR(10))
BEGIN
  DELETE FROM SINH_VIEN WHERE MaLop = p_MALOP;
  DELETE FROM LOP WHERE MALOP = p_MALOP;
END //

-- GIẢNG VIÊN
DROP PROCEDURE IF EXISTS sp_ThemGiangVien //
CREATE PROCEDURE sp_ThemGiangVien(
  IN p_MAGV CHAR(10),
  IN p_HOTEN VARCHAR(100),
  IN p_MAKHOA CHAR(5)
)
BEGIN
  IF EXISTS (SELECT 1 FROM GIANG_VIEN WHERE MaGV = p_MAGV) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mã giảng viên đã tồn tại.';
  ELSE
    INSERT INTO GIANG_VIEN (MaGV, HoTen, MAKHOA) VALUES (p_MAGV, p_HOTEN, p_MAKHOA);
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_SuaGiangVien //
CREATE PROCEDURE sp_SuaGiangVien(
  IN p_MAGV CHAR(10),
  IN p_HOTEN VARCHAR(100),
  IN p_MAKHOA CHAR(5)
)
BEGIN
  IF NOT EXISTS (SELECT 1 FROM GIANG_VIEN WHERE MaGV = p_MAGV) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không tìm thấy giảng viên.';
  ELSE
    UPDATE GIANG_VIEN SET HoTen = p_HOTEN, MAKHOA = p_MAKHOA WHERE MaGV = p_MAGV;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XoaGiangVien //
CREATE PROCEDURE sp_XoaGiangVien(IN p_MAGV CHAR(10))
BEGIN
  DELETE FROM TAIKHOAN WHERE RELATED_ID = p_MAGV;
  DELETE FROM GIANG_VIEN WHERE MaGV = p_MAGV;
END //

-- KHOA
DROP PROCEDURE IF EXISTS sp_ThemKhoa //
CREATE PROCEDURE sp_ThemKhoa(
  IN p_MAKHOA CHAR(5),
  IN p_TENKHOA VARCHAR(100)
)
BEGIN
  IF EXISTS (SELECT 1 FROM KHOA WHERE MAKHOA = p_MAKHOA) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mã khoa đã tồn tại.';
  ELSE
    INSERT INTO KHOA (MAKHOA, TENKHOA) VALUES (p_MAKHOA, p_TENKHOA);
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_SuaKhoa //
CREATE PROCEDURE sp_SuaKhoa(
  IN p_MAKHOA CHAR(5),
  IN p_TENKHOA VARCHAR(100)
)
BEGIN
  IF NOT EXISTS (SELECT 1 FROM KHOA WHERE MAKHOA = p_MAKHOA) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không tìm thấy khoa.';
  ELSE
    UPDATE KHOA SET TENKHOA = p_TENKHOA WHERE MAKHOA = p_MAKHOA;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XoaKhoa //
CREATE PROCEDURE sp_XoaKhoa(IN p_MAKHOA CHAR(5))
BEGIN
  DELETE FROM GIANG_VIEN WHERE MAKHOA = p_MAKHOA;
  DELETE FROM LOP WHERE MAKHOA = p_MAKHOA;
  DELETE FROM KHOA WHERE MAKHOA = p_MAKHOA;
END //

-- TÀI KHOẢN
DROP PROCEDURE IF EXISTS sp_ThemTaiKhoan //
CREATE PROCEDURE sp_ThemTaiKhoan(
  IN p_USERNAME VARCHAR(50),
  IN p_PASSWORD_HASH VARCHAR(255),
  IN p_ROLE VARCHAR(20),
  IN p_RELATED_ID VARCHAR(20)
)
BEGIN
  IF EXISTS (SELECT 1 FROM TAIKHOAN WHERE USERNAME = p_USERNAME) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Tài khoản đã tồn tại.';
  ELSE
    INSERT INTO TAIKHOAN (USERNAME, PASSWORD_HASH, `ROLE`, RELATED_ID)
    VALUES (p_USERNAME, p_PASSWORD_HASH, p_ROLE, p_RELATED_ID);
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_SuaTaiKhoan //
CREATE PROCEDURE sp_SuaTaiKhoan(
  IN p_USERNAME VARCHAR(50),
  IN p_PASSWORD_HASH VARCHAR(255),
  IN p_ROLE VARCHAR(20),
  IN p_RELATED_ID VARCHAR(20)
)
BEGIN
  IF NOT EXISTS (SELECT 1 FROM TAIKHOAN WHERE USERNAME = p_USERNAME) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không tìm thấy tài khoản.';
  ELSE
    UPDATE TAIKHOAN
      SET PASSWORD_HASH = p_PASSWORD_HASH, `ROLE` = p_ROLE, RELATED_ID = p_RELATED_ID
    WHERE USERNAME = p_USERNAME;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XoaTaiKhoan //
CREATE PROCEDURE sp_XoaTaiKhoan(IN p_USERNAME VARCHAR(50))
BEGIN
  DELETE FROM TAIKHOAN WHERE USERNAME = p_USERNAME;
END //

-- HỌC PHẦN
DROP PROCEDURE IF EXISTS sp_ThemHocPhan //
CREATE PROCEDURE sp_ThemHocPhan(
  IN p_MaHP CHAR(10),
  IN p_TenHP VARCHAR(100),
  IN p_SoTinChi INT,
  IN p_HocKy INT,
  IN p_NamHoc CHAR(9),
  IN p_MaLop CHAR(10),
  IN p_GiangVien VARCHAR(100),
  IN p_NgayBatDau DATE,
  IN p_NgayKetThuc DATE
)
BEGIN
  IF EXISTS (SELECT 1 FROM HOC_PHAN WHERE MaHP = p_MaHP) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mã học phần đã tồn tại!';
  ELSE
    INSERT INTO HOC_PHAN (MaHP, TenHP, SoTinChi, HocKy, NamHoc, MaLop, GiangVien, NgayBatDau, NgayKetThuc)
    VALUES (p_MaHP, p_TenHP, p_SoTinChi, p_HocKy, p_NamHoc, p_MaLop, p_GiangVien, p_NgayBatDau, p_NgayKetThuc);
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_SuaHocPhan //
CREATE PROCEDURE sp_SuaHocPhan(
  IN p_MaHP CHAR(10),
  IN p_TenHP VARCHAR(100),
  IN p_SoTinChi INT,
  IN p_HocKy INT,
  IN p_NamHoc CHAR(9),
  IN p_MaLop CHAR(10),
  IN p_GiangVien VARCHAR(100),
  IN p_NgayBatDau DATE,
  IN p_NgayKetThuc DATE
)
BEGIN
  IF NOT EXISTS (SELECT 1 FROM HOC_PHAN WHERE MaHP = p_MaHP) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không tìm thấy học phần!';
  ELSE
    UPDATE HOC_PHAN
      SET TenHP = p_TenHP,
          SoTinChi = p_SoTinChi,
          HocKy = p_HocKy,
          NamHoc = p_NamHoc,
          MaLop = p_MaLop,
          GiangVien = p_GiangVien,
          NgayBatDau = p_NgayBatDau,
          NgayKetThuc = p_NgayKetThuc
    WHERE MaHP = p_MaHP;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XoaHocPhan //
CREATE PROCEDURE sp_XoaHocPhan(IN p_MaHP CHAR(10))
BEGIN
  IF NOT EXISTS (SELECT 1 FROM HOC_PHAN WHERE MaHP = p_MaHP) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Học phần không tồn tại!';
  ELSEIF EXISTS (SELECT 1 FROM DIEM WHERE MaHP = p_MaHP) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Không thể xóa học phần vì đã có điểm được nhập!';
  ELSE
    DELETE FROM HOC_PHAN WHERE MaHP = p_MaHP;
    SELECT 'Đã xóa học phần thành công!' AS message;
  END IF;
END //

DROP PROCEDURE IF EXISTS sp_XemDanhSachHocPhan //
CREATE PROCEDURE sp_XemDanhSachHocPhan()
BEGIN
  SELECT * FROM HOC_PHAN ORDER BY NamHoc, HocKy, TenHP;
END //

DROP PROCEDURE IF EXISTS sp_TimKiemHocPhan //
CREATE PROCEDURE sp_TimKiemHocPhan(IN p_TuKhoa VARCHAR(100))
BEGIN
  SELECT * FROM HOC_PHAN
   WHERE TenHP   LIKE CONCAT('%', p_TuKhoa, '%')
      OR MaHP    LIKE CONCAT('%', p_TuKhoa, '%')
      OR GiangVien LIKE CONCAT('%', p_TuKhoa, '%');
END //

-- FUNCTION
DROP FUNCTION IF EXISTS fn_TongTinChiSinhVien //
CREATE FUNCTION fn_TongTinChiSinhVien(p_MaSV CHAR(10))
RETURNS INT
DETERMINISTIC
READS SQL DATA
BEGIN
  DECLARE vTongTC INT;
  SELECT SUM(HP.SoTinChi)
    INTO vTongTC
    FROM DIEM D
    JOIN HOC_PHAN HP ON D.MaHP = HP.MaHP
   WHERE D.MaSV = p_MaSV;
  RETURN IFNULL(vTongTC, 0);
END //

DELIMITER ;

-- =========================
-- Test (MySQL dùng CALL)
-- =========================
CALL sp_ThemSinhVien ('SV006','Ngô Thanh H','L001');
CALL sp_SuaSinhVien  ('SV006','Ngô Thanh Hải','L002');
CALL sp_XoaSinhVien  ('SV006');

CALL sp_ThemLop ('L004','CTK44','K001');
CALL sp_SuaLop  ('L004','Công nghệ phần mềm 44','K001');
CALL sp_XoaLop  ('L004');

CALL sp_ThemGiangVien ('GV003','ThS. Nguyễn Minh','K001');
CALL sp_SuaGiangVien  ('GV003','TS. Nguyễn Minh Quân','K002');
CALL sp_XoaGiangVien  ('GV003');

CALL sp_ThemKhoa ('K004','Ngôn ngữ Anh');
CALL sp_SuaKhoa  ('K004','Ngôn ngữ và Dịch thuật');
CALL sp_XoaKhoa  ('K004');

CALL sp_ThemTaiKhoan ('sv_tranb','HASHEDPASSWORD123','SINHVIEN','SV002');
CALL sp_SuaTaiKhoan  ('sv_tranb','NEWHASH456','SINHVIEN','SV002');
CALL sp_XoaTaiKhoan  ('sv_tranb');

-- Truy vấn kiểm tra
SELECT * FROM SINH_VIEN;
SELECT * FROM LOP;
SELECT * FROM GIANG_VIEN;
SELECT * FROM KHOA;
SELECT * FROM TAIKHOAN;

UPDATE TAIKHOAN
SET PASSWORD_HASH = '$2b$10$hKzRcHoq0bU2KXMnpYcEle6w5ggHYHtF4jOnDLz.CFZ0hpMNa.ndS'
WHERE USERNAME = 'admin';

SELECT USERNAME, LENGTH(PASSWORD_HASH) AS len FROM TAIKHOAN WHERE USERNAME='admin';

